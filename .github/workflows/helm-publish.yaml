name: Helm Chart Lint & Publish

# Automated Helm chart validation and OCI publishing pipeline
# Triggers on: push to main (publish), pull_request to main (lint only)
# Registry: Harbor at registry.dev.weaura.ai

on:
  push:
    branches: [main]
    paths:
      - 'apps/*/helm/**'
      - '.github/workflows/helm-publish.yaml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/*/helm/**'
      - '.github/workflows/helm-publish.yaml'

permissions:
  contents: read

jobs:
  # Detect which charts have changed to optimize pipeline execution
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.filter.outputs.changes }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed chart directories
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            grafana:
              - 'apps/grafana/helm/**'

  # Lint Helm charts (runs on PRs and pushes)
  lint:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.charts != '[]' && needs.detect-changes.outputs.charts != '' }}
    strategy:
      matrix:
        chart: ${{ fromJSON(needs.detect-changes.outputs.charts) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Setup mise (for tool version management)
        uses: jdx/mise-action@v2
        with:
          experimental: true

      - name: Update chart dependencies
        run: |
          CHART_DIR="apps/${{ matrix.chart }}/helm/weaura-${{ matrix.chart }}"
          echo "ðŸ” Processing chart in: ${CHART_DIR}"
          if [ ! -d "${CHART_DIR}" ]; then
            echo "âŒ Chart directory not found: ${CHART_DIR}"
            exit 1
          fi
          cd "${CHART_DIR}"
          echo "ðŸ“¦ Updating dependencies for $(basename ${CHART_DIR})..."
          helm dependency update

      - name: Lint Helm chart
        run: |
          CHART_DIR="apps/${{ matrix.chart }}/helm/weaura-${{ matrix.chart }}"
          cd "${CHART_DIR}"
          echo "ðŸ” Linting $(basename ${CHART_DIR})..."
          helm lint .

  # Package and push charts to Harbor OCI registry (only on push to main)
  publish:
    runs-on: ubuntu-latest
    needs: [detect-changes, lint]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.charts != '[]' && 
      needs.detect-changes.outputs.charts != ''
    strategy:
      matrix:
        chart: ${{ fromJSON(needs.detect-changes.outputs.charts) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Setup mise
        uses: jdx/mise-action@v2
        with:
          experimental: true

      - name: Update chart dependencies
        run: |
          CHART_DIR="apps/${{ matrix.chart }}/helm/weaura-${{ matrix.chart }}"
          cd "${CHART_DIR}"
          echo "ðŸ“¦ Updating dependencies for $(basename ${CHART_DIR})..."
          helm dependency update

      - name: Package Helm chart
        id: package
        run: |
          CHART_DIR="apps/${{ matrix.chart }}/helm/weaura-${{ matrix.chart }}"
          cd "${CHART_DIR}"
          CHART_NAME=$(yq eval '.name' Chart.yaml)
          CHART_VERSION=$(yq eval '.version' Chart.yaml)
          echo "ðŸ“¦ Packaging ${CHART_NAME}:${CHART_VERSION}..."
          helm package .
          echo "chart_name=${CHART_NAME}" >> $GITHUB_OUTPUT
          echo "chart_version=${CHART_VERSION}" >> $GITHUB_OUTPUT
          echo "package_file=${CHART_NAME}-${CHART_VERSION}.tgz" >> $GITHUB_OUTPUT

      - name: Login to Harbor OCI Registry
        run: |
          # GitHub Secrets required:
          # - HARBOR_USERNAME: Harbor robot account or user with push permissions
          # - HARBOR_PASSWORD: Harbor password or robot account token
          echo "${{ secrets.HARBOR_PASSWORD }}" | helm registry login registry.dev.weaura.ai \
            --username "${{ secrets.HARBOR_USERNAME }}" \
            --password-stdin

      - name: Push chart to Harbor
        run: |
          CHART_DIR="apps/${{ matrix.chart }}/helm/weaura-${{ matrix.chart }}"
          cd "${CHART_DIR}"
          PACKAGE_FILE="${{ steps.package.outputs.package_file }}"
          REGISTRY_URL="oci://registry.dev.weaura.ai/weaura-vendorized"
          
          echo "ðŸš€ Pushing ${PACKAGE_FILE} to ${REGISTRY_URL}..."
          helm push "${PACKAGE_FILE}" "${REGISTRY_URL}"
          
          echo "âœ… Successfully published:"
          echo "   Chart: ${{ steps.package.outputs.chart_name }}"
          echo "   Version: ${{ steps.package.outputs.chart_version }}"
          echo "   Registry: ${REGISTRY_URL}"

      - name: Logout from Harbor
        if: always()
        run: |
          helm registry logout registry.dev.weaura.ai || true
