apiVersion: 1
groups:
  - name: disk-alerts
    interval: 1m
    rules:
      - uid: weaura-disk-space
        title: High Disk Space Usage
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: ${DS_PROMETHEUS}
            model:
              expr: 100 - ((node_filesystem_avail_bytes{fstype!="tmpfs", mountpoint="/"} / node_filesystem_size_bytes{fstype!="tmpfs", mountpoint="/"}) * 100)
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: reduce
              refId: B
              expression: A
              reducer: mean
              settings:
                mode: replaceNonNumericValues
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              refId: C
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 85
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  type: query
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: High disk space usage detected
          description: "Node {{ $labels.instance }} has disk usage above 85% (current value: {{ $value }}%)"
        labels:
          severity: warning
          team: platform
